/* Copyright (C), 1996-2006, Techmation. Co., Ltd.*/

/*===========================================================================+
|  Class    : Selvat Manager                                                 |
|  Task     : Selvat Manager file                                            |
|----------------------------------------------------------------------------|
|  Compile  :G++(GCC) 3.2                                                    |
|  Link     :G++(GCC) 3.2                                                    |
|  Call     :                                                                |
|----------------------------------------------------------------------------|
|  Author   : C.C. Chen                                                      |
|  Version  : V1.00                                                          |
|  Creation : 04/23/1996                                                     |
|  Revision : 09/19/2003   Jeckey                                            |
+===========================================================================*/

#include    "selvat.h"
#include    "database.h"
#include    "main.h"
#include    "files.h"
#include	"init.h"
/*===========================================================================+
|           External                                                         |
+===========================================================================*/

/*===========================================================================+
|           Constant                                                         |
+===========================================================================*/
/*===========================================================================+
|           Global variable                                                  |
+===========================================================================*/
static int  Real58TonTable[] = {
            0,
            1,
            2,
            3,
            4,
            5,
            6,
            7,
            8,
            9,
            10,
            49,
            111,
            195,
            301,
            427,
            569,
            727,
            898,
            1078,
            1265,
            1455,
            1645,
            1833,
            2014,
            2186,
            2347,
            2496,
            2632,
            2732,
            2820
            };

static int  Oil58TonTable[] = {             //KV2002/12/05 ADD __based(__segname("SYSTEM"))
            0,
            131,
            176,
            203,
            230,
            252,
            275,
            289,
            302,
            319,
            333,
            580,
            753,
            901,
            1035,
            1160,
            1282,
            1403,
            1526,
            1645,
            1789,
            1933,
            2086,
            2246,
            2412,
            2580,
            2744,
            2902,
            3047,
            3152,
            3250
            };

static int  Real80TonTable[] = {            //KV2002/12/05 ADD __based(__segname("SYSTEM"))
            0,
            1,
            2,
            3,
            4,
            5,
            6,
            7,
            8,
            9,
            10,
            11,
            12,
            56,
            127,
            224,
            345,
            490,
            654,
            836,
            1034,
            1242,
            1459,
            1680,
            1902,
            2120,
            2331,
            2532,
            2720,
            2894,
            3051,
            3130,
            3200
            };

static int  Oil80TonTable[] = {             //KV2002/12/05 ADD __based(__segname("SYSTEM"))
            0,
            172,
            202,
            254,
            277,
            318,
            338,
            356,
            374,
            391,
            407,
            423,
            437,
            742,
            962,
            1150,
            1320,
            1479,
            1634,
            1787,
            1941,
            2099,
            2263,
            2434,
            2613,
            2798,
            2988,
            3180,
            3369,
            3552,
            3724,
            3809,
            3880
            };

static int  Real110TonTable[] = {           //KV2002/12/05 ADD __based(__segname("SYSTEM"))
               0,
               1,
               2,
               3,
               4,
               5,
               6,
               7,
               8,
               9,
              10,
              11,
              12,
              13,
              14,
              59,
             134,
             237,
             367,
             520,
             695,
             889,
            1098,
            1320,
            1551,
            1786,
            2023,
            2257,
            2484,
            2702,
            2908,
            3100,
            3276,
            3401,
            3550
            };

static int  Oil110TonTable[] = {            //KV2002/12/05 ADD __based(__segname("SYSTEM"))
             0,
             159,
             234,
             265,
             319,
             343,
             366,
             388,
             409,
             429,
             448,
             467,
             485,
             502,
             505,
             800,
            1091,
            1304,
            1496,
            1677,
            1851,
            2024,
            2198,
            2375,
            2559,
            2749,
            2948,
            3153,
            3363,
            3574,
            3784,
            3987,
            4177,
            4311,
            4600
            };

static int  Real150TonTable[] = {           //KV2002/12/05 ADD __based(__segname("SYSTEM"))
            0,
            1,
            2,
            3,
            4,
            5,
            6,
            8,
            9,
            10,
            11,
            12,
            14,
            15,
            16,
            72,
            163,
            289,
            446,
            634,
            848,
            1086,
            1344,
            1618,
            1903,
            2194,
            2486,
            2773,
            3050,
            3313,
            3556,
            3779,
            3979,
            4099,
            4300
            };

static int  Oil150TonTable[] = {            //KV2002/12/05 ADD __based(__segname("SYSTEM"))
            0,
            187,
            235,
            275,
            345,
            375,
            404,
            431,
            456,
            481,
            504,
            527,
            548,
            569,
            579,
            978,
            1272,
            1521,
            1745,
            1956,
            2159,
            2359,
            2559,
            2761,
            2966,
            3177,
            3394,
            3614,
            3838,
            4062,
            4283,
            4497,
            4699,
            4824,
            5100
            };

static int  Real200TonTable[] = {           //KV2002/12/05 ADD __based(__segname("SYSTEM"))
               0,
               1,
               2,
               3,
               4,
               5,
               6,
               7,
               9,
              10,
              11,
              13,
              14,
              16,
              18,
              83,
             187,
             331,
             512,
             727,
             973,
            1247,
            1544,
            1860,
            2189,
            2526,
            2863,
            3193,
            3510,
            3806,
            4077,
            4319,
            4531,
            4602,
            4800
            };

static int  Oil200TonTable[] = {            //KV2002/12/05 ADD __based(__segname("SYSTEM"))
             0,
             158,
             199,
             235,
             266,
             294,
             320,
             344,
             367,
             389,
             410,
             430,
             449,
             467,
             494,
             828,
            1073,
            1280,
            1466,
            1638,
            1803,
            1961,
            2116,
            2269,
            2420,
            2569,
            2717,
            2864,
            3008,
            3149,
            3285,
            3414,
            3535,
            3577,
            3800
            };

static int  RealQ200TonTable[] = {           //WJ2003/8/4 add to here //KV2002/12/05 ADD __based(__segname("SYSTEM"))
               0,
               1,
               2,
               3,
               4,
               5,
               6,
               7,
               8,
               9,
              10,
              11,
              12,
              13,
              14,
              15,
              77,
             173,
             304,
             470,
             666,
             890,
            1139,
            1408,
            1693,
            1990,
            2293,
            2598,
            2898,
            3189,
            3466,
            3725,
            3965,
            4183,
            4379,
            4498,
            4560
            };

static int  OilQ200TonTable[] = {            //KV2002/12/05 ADD __based(__segname("SYSTEM"))
               0,
             172,
             256,
             299,
             338,
             372,
             400,
             425,
             448,
             469,
             488,
             505,
             522,
             537,
             551,
             565,
             972,
            1248,
            1484,
            1697,
            1898,
            2092,
            2285,
            2480,
            2680,
            2888,
            3106,
            3336,
            3575,
            3822,
            4073,
            4322,
            4563,
            4791,
            4998,
            5120,
            5170
            };

static int  Real250TonTable[] = {          //KV2002/12/05 ADD __based(__segname("SYSTEM"))
               0,
               1,
               2,
               3,
               4,
               5,
               6,
               7,
               8,
               9,
              11,
              12,
              14,
              15,
              17,
              18,
              19,
              91,
             204,
             359,
             554,
             784,
            1048,
            1340,
            1656,
            1990,
            2338,
            2692,
            3046,
            3393,
            3726,
            4041,
            4331,
            4594,
            4829,
            5037,
            5198,
            5350,
            5500
            };
static int  Oil250TonTable[] = {         //KV2002/12/05 ADD __based(__segname("SYSTEM"))
               0,
             122,
             195,
             225,
             252,
             278,
             301,
             324,
             345,
             366,
             385,
             404,
             422,
             440,
             457,
             473,
             477,
             816,
            1051,
            1252,
            1434,
            1603,
            1765,
            1922,
            2076,
            2228,
            2380,
            2531,
            2681,
            2831,
            2979,
            3124,
            3265,
            3401,
            3529,
            3646,
            3738,
            3820,
            3950
            };
static int  Real300TonTable[] = {          //KV2002/12/05 ADD __based(__segname("SYSTEM"))
               0,
               1,
               2,
               3,
               4,
               5,
               6,
               7,
               9,
              10,
              11,
              13,
              15,
              16,
              18,
              20,
              22,
             101,
             227,
             400,
             617,
             875,
            1169,
            1496,
            1850,
            1990,
            2616,
            3014,
            3413,
            3805,
            4182,
            4539,
            4870,
            5171,
            5441,
            5680,
            5891,
            6031,
            6200
            };
static int  Oil300TonTable[] = {             //KV2002/12/05 ADD __based(__segname("SYSTEM"))
               0,
             192,
             244,
             288,
             326,
             361,
             394,
             424,
             453,
             480,
             505,
             530,
             554,
             577,
             599,
             621,
             642,
            1061,
            1360,
            1615,
            1845,
            2061,
            2267,
            2469,
            2669,
            2870,
            3071,
            3276,
            3482,
            3691,
            3902,
            4111,
            4318,
            4519,
            4710,
            4888,
            5048,
            5153,
            5250
            };

static int  Real360TonTable[] = {            //KV2002/12/05 ADD __based(__segname("SYSTEM"))
            0,
            1,
            2,
            3,
            4,
            6,
            7,
            8,
            10,
            11,
            13,
            15,
            16,
            18,
            20,
            22,
            23,
            113,
            255,
            449,
            692,
            982,
            1313,
            1681,
            2079,
            2501,
            2940,
            3389,
            3838,
            4278,
            4702,
            5101,
            5469,
            5803,
            6100,
            6362,
            6591,
            6634,
            6700
            };
static int  Oil360TonTable[] = {             //KV2002/12/05 ADD __based(__segname("SYSTEM"))
            0,
            137,
            264,
            312,
            354,
            392,
            427,
            460,
            491,
            521,
            549,
            576,
            602,
            627,
            651,
            674,
            682,
            1153,
            1479,
            1757,
            2008,
            2243,
            2467,
            2686,
            2902,
            3117,
            3333,
            3549,
            3767,
            3985,
            4203,
            4419,
            4629,
            4833,
            5025,
            5203,
            5361,
            5391,
            5430
            };

static int  Real450TonTable[] = {            //KV2002/12/05 ADD __based(__segname("SYSTEM"))
               0,
               1,
               2,
               3,
               4,
               6,
               7,
               9,
              10,
              12,
              14,
              15,
              17,
              19,
              21,
              24,
              25,
             124,
             279,
             492,
             760,
            1076,
            1430,
            1840,
            2276,
            2737,
            3217,
            3706,
            4196,
            4677,
            5140,
            5576,
            5980,
            6348,
            6800,
            7450
            };

static int  Oil450TonTable[] = {             //KV2002/12/05 ADD __based(__segname("SYSTEM"))
               0,
             180,
             263,
             320,
             366,
             433,
             472,
             508,
             542,
             574,
             605,
             634,
             663,
             690,
             716,
             742,
             752,
            1271,
            1622,
            1920,
            2188,
            2439,
            2680,
            2916,
            3151,
            3388,
            3629,
            3876,
            4129,
            4389,
            4654,
            4922,
            5191,
            5455,
            5950,
            6360
            };

static int  Real530TonTable[] = {            //KV2002/12/05 ADD __based(__segname("SYSTEM"))
           0,
           1,
           2,
           3,
           4,
           5,
           7,
           8,
          10,
          12,
          14,
          16,
          18,
          20,
          22,
          25,
          27,
         117,
         283,
         517,
         816,
        1174,
        1586,
        2046,
        2548,
        3082,
        3641,
        4213,
        4788,
        5355,
        5901,
        6416,
        6891,
        7320,
        7701,
        8033,
        8200,
        8300
        };
static int  Oil530TonTable[] = {             //KV2002/12/05 ADD __based(__segname("SYSTEM"))
           0,
         219,
         311,
         382,
         443,
         496,
         545,
         590,
         631,
         671,
         708,
         744,
         778,
         810,
         842,
         872,
         891,
        1422,
        1846,
        2202,
        2521,
        2818,
        3100,
        3373,
        3642,
        3909,
        4175,
        4441,
        4709,
        4977,
        5245,
        5510,
        5770,
        6021,
        6261,
        6485,
        6601,
        6700
        };

static int  Real650TonTable[] = {           //KV2002/12/05 ADD __based(__segname("SYSTEM"))
               0,
               1,
               2,
               3,
               5,
               6,
               8,
              10,
              11,
              13,
              15,
              18,
              20,
              22,
              25,
              28,
              31,
              31,
             155,
             348,
             613,
             946,
            1341,
            1792,
            2293,
            2834,
            3408,
            4005,
            4613,
            5222,
            5820,
            6396,
            6941,
            7445,
            7906,
            8319,
            8686,
            9010,
            9050,
            9080
            };
static int  Oil650TonTable[] = {            //KV2002/12/05 ADD __based(__segname("SYSTEM"))
               0,
             180,
             273,
             346,
             408,
             462,
             512,
             558,
             601,
             642,
             680,
             717,
             752,
             785,
             818,
             849,
             880,
             881,
            1505,
            1930,
            2292,
            2620,
            2926,
            3220,
            3508,
            3794,
            4080,
            4369,
            4663,
            4960,
            5261,
            5565,
            5868,
            6167,
            6457,
            6733,
            6990,
            7220,
            7248,
            7280
            };

static int  Real700TonTable[] = {           //KV2002/12/05 ADD __based(__segname("SYSTEM"))
            0,
            1,
            2,
            3,
            5,
            6,
            8,
            9,
            11,
            13,
            15,
            17,
            20,
            22,
            25,
            28,
            31,
            32,
            161,
            362,
            637,
            982,
            1392,
            1860,
            2380,
            2942,
            3538,
            4157,
            4789,
            5421,
            6043,
            6643,
            7211,
            7739,
            8222,
            8657,
            9044,
            9387,
            9500,
            9600
            };
static int  Oil700TonTable[] = {            //KV2002/12/05 ADD __based(__segname("SYSTEM"))
            0,
            214,
            320,
            403,
            473,
            536,
            592,
            644,
            693,
            739,
            783,
            824,
            864,
            902,
            939,
            975,
            1009,
            1029,
            1726,
            2203,
            2611,
            2978,
            3322,
            3651,
            3971,
            4287,
            4601,
            4916,
            5231,
            5549,
            5867,
            6184,
            6498,
            6806,
            7103,
            7385,
            7646,
            7880,
            7957,
            8057
            };

static int  Real780TonTable[] = {           //KV2002/12/05 ADD __based(__segname("SYSTEM"))
               0,
               1,
               2,
               4,
               5,
               7,
               8,
              10,
              12,
              14,
              17,
              19,
              22,
              24,
              27,
              30,
              33,
              34,
             169,
             380,
             669,
            1032,
            1463,
            1956,
            2502,
            3094,
            3721,
            4373,
            5038,
            5703,
            6357,
            6985,
            7579,
            8127,
            8626,
            9073,
            9468,
            9797,
            9900
            };
static int  Oil780TonTable[] = {            //KV2002/12/05 ADD __based(__segname("SYSTEM"))
               0,
             259,
             368,
             452,
             523,
             586,
             644,
             697,
             746,
             792,
             836,
             878,
             918,
             957,
             994,
            1030,
            1065,
            1074,
            1775,
            2256,
            2666,
            3035,
            3379,
            3707,
            4026,
            4339,
            4648,
            4957,
            5265,
            5573,
            5881,
            6186,
            6486,
            6788,
            7063,
            7331,
            7579,
            7789,
            7880
            };

static int  Real800TonTable[] = {           //KV2002/12/05 ADD __based(__segname("SYSTEM"))
            0,      //0,
            1,      //217,
            2,      //324,
            4,      //408,
            5,      //479,
            7,      //542,
            9,      //599,
            10,     //652,
            13,     //701,
            15,     //747,
            17,     //791,
            20,     //834,
            22,     //874,
            25,     //913,
            28,     //950,
            31,     //986,
            34,     //1016,
            177,    //1744,
            398,    //2231,
            702,    //2646,
            1083,   //3022,
            1535,   //3374,
            2053,   //3712,
            2627,   //4043,
            3249,   //4372,
            3908,   //4701,
            4594,   //5034,
            5293,   //5372,
            5993,   //5716,
            6680,   //6063,
            7341,   //6413,
            7964,   //6763,
            8540,   //7108,
            9062,   //7443,
            9527,   //7761,
            9938,   //8057,
            10193,  //8243,
            10293   //8343
            };
static int  Oil800TonTable[] = {            //KV2002/12/05 ADD __based(__segname("SYSTEM"))
            0,
            217,
            324,
            408,
            479,
            542,
            599,
            652,
            701,
            747,
            791,
            834,
            874,
            913,
            950,
            986,
            1016,
            1744,
            2231,
            2646,
            3022,
            3374,
            3712,
            4043,
            4372,
            4701,
            5034,
            5372,
            5716,
            6063,
            6413,
            6763,
            7108,
            7443,
            7761,
            8057,
            8243,
            8343
            };

static int  Real1000TonTable[] = {          //KV2002/12/05 ADD __based(__segname("SYSTEM"))
                0,
                1,
                3,
                4,
                6,
                8,
               10,
               12,
               14,
               16,
               19,
               22,
               25,
               28,
               31,
               34,
               38,
               41,
              193,
              434,
              764,
             1179,
             1672,
             2235,
             2860,
             3536,
             4253,
             4999,
             5759,
             6521,
             7269,
             7989,
             8668,
             9297,
             9870,
            10382,
            10836,
            10997,
            11140
            };

static int  Oil1000TonTable[] = {           //KV2002/12/05 ADD __based(__segname("SYSTEM"))
               0,
             239,
             357,
             449,
             527,
             597,
             660,
             718,
             772,
             824,
             872,
             919,
             963,
            1006,
            1047,
            1087,
            1126,
            1155,
            1919,
            2458,
            2919,
            3335,
            3725,
            4099,
            4464,
            4826,
            5187,
            5550,
            5917,
            6287,
            6659,
            7032,
            7401,
            7764,
            8114,
            8445,
            8749,
            8859,
            8880
            };

static int  Real1250TonTable[] = {          //KV2002/12/05 ADD __based(__segname("SYSTEM"))
                0,
                2,
                3,
                6,
                8,
               11,
               14,
               17,
               20,
               23,
               26,
               30,
               33,
               37,
               40,
              205,
              468,
              828,
             1280,
             1817,
             2432,
             3114,
             3853,
             4637,
             5452,
             6284,
             7117,
             7934,
             8720,
             9460,
            10143,
            10761,
            11311,
            11796,
            12219,
            12490,
            12730
            };

static int  Oil1250TonTable[] = {        //KV2002/12/05 ADD __based(__segname("SYSTEM"))
                0,
              354,
              503,
              619,
              716,
              803,
              881,
              954,
             1021,
             1085,
             1145,
             1203,
             1258,
             1311,
             1349,
             2340,
             3021,
             3595,
             4109,
             4587,
             5042,
             5483,
             5914,
             6340,
             6763,
             7185,
             7604,
             8022,
             8435,
             8840,
             9235,
             9613,
             9970,
            10298,
            10591,
            10775,
            11020
            };

static int  Real120WTonTable[] = {          //KV2002/12/05 ADD __based(__segname("SYSTEM"))
                0,
                1,
                2,
                3,
                4,
                5,
                6,
                7,
                8,
                9,
               10,
               11,
               12,
               13,
               61,
              136,
              240,
              371,
              525,
              702,
              898,
             1110,
             1334,
             1568,
             1807,
             2047,
             2285,
             2517,
             2739,
             2950,
             3146,
             3327,
             3493,
             3530,
             3550
            };

static int  Oil120WTonTable[] = {        //KV2002/12/05 ADD __based(__segname("SYSTEM"))
                0,
              188,
              261,
              311,
              351,
              383,
              411,
              436,
              458,
              479,
              497,
              515,
              531,
              546,
              903,
             1156,
             1372,
             1566,
             1749,
             1925,
             2099,
             2275,
             2454,
             2641,
             2836,
             3041,
             3255,
             3476,
             3703,
             3929,
             4151,
             4363,
             4559,
             4602,
             4700
            };

static int  Real1250WTonTable[] = {          //KV2002/12/05 ADD __based(__segname("SYSTEM"))
                0,
                1,
                3,
                5,
                7,
                9,
               11,
               14,
               16,
               19,
               22,
               26,
               29,
               33,
               37,
               41,
               45,
               46,
              237,
              533,
              939,
             1448,
             2052,
             2741,
             3505,
             4332,
             5207,
             6117,
             7045,
             7975,
             8890,
             9775,
            10616,
            11401,
            12123,
            12779,
            13367,
            13891,
            14355,
            14552,
            14750
            };

static int  Oil1250WTonTable[] = {        //KV2002/12/05 ADD __based(__segname("SYSTEM"))
                0,
              198,
              417,
              540,
              634,
              711,
              781,
              851,
              917,
              980,
             1039,
             1095,
             1149,
             1201,
             1251,
             1299,
             1346,
             1357,
             2320,
             2968,
             3520,
             4018,
             4485,
             4934,
             5374,
             5811,
             6251,
             6697,
             7152,
             7617,
             8091,
             8572,
             9056,
             9536,
            10006,
            10457,
            10879,
            11262,
            11593,
            11725,
            11850
            };

static int  Real1260TonTable[] = {          //KV2002/12/05 ADD __based(__segname("SYSTEM"))
                0,
                1,
                2,
                4,
                6,
                8,
               10,
               12,
               15,
               17,
               20,
               23,
               26,
               30,
               33,
               37,
               41,
               42,
              214,
              481,
              847,
             1305,
             1850,
             2472,
             3161,
             3907,
             4698,
             5519,
             6356,
             7194,
             8017,
             8811,
             9561,
            10258,
            10893,
            11466,
            11975,
            12424,
            12820,
            12995,
            13100
            };

static int  Oil1260TonTable[] = {        //KV2002/12/05 ADD __based(__segname("SYSTEM"))
                0,
              277,
              351,
              519,
              610,
              690,
              763,
              830,
              893,
              952,
             1008,
             1062,
             1113,
             1162,
             1210,
             1256,
             1300,
             1310,
             2225,
             2841,
             3366,
             3841,
             4285,
             4713,
             5131,
             5547,
             5966,
             6389,
             6821,
             7260,
             7708,
             8160,
             8613,
             9063,
             9501,
             9921,
            10312,
            10664,
            10966,
            11092,
            11200
            };

static int  Real1600TonTable[] = {          //ST2004/02/04 ADD
            0,
            1,
            3,
            5,
            7,
            9,
            11,
            14,
            17,
            20,
            23,
            26,
            30,
            34,
            37,
            41,
            46,
            49,
            243,
            545,
            959,
            1478,
            2093,
            2795,
            3571,
            4410,
            5298,
            6219,
            7159,
            8098,
            9023,
            9917,
            10767,
            11561,
            12293,
            12958,
            13558,
            14095,
            14572,
            14997,
            15340
            };

static int  Oil1600TonTable[] = {        //St2004/02/04 ADD
            0,
            253,
            438,
            566,
            663,
            743,
            819,
            895,
            962,
            1027,
            1088,
            1146,
            1202,
            1256,
            1307,
            1357,
            1406,
            1438,
            2412,
            3074,
            3636,
            4142,
            4614,
            5068,
            5512,
            5954,
            6400,
            6854,
            7320,
            7799,
            8292,
            8797,
            9310,
            9825,
            10336,
            10832,
            11305,
            11742,
            12132,
            12461,
            12700
            };

SELVATTABLE		g_aSelvatTable[] = {
    {0x0058, sizeof(Real58TonTable  ), Real58TonTable  , Oil58TonTable  },
    {0x0080, sizeof(Real80TonTable  ), Real80TonTable  , Oil80TonTable  },
    {0x0110, sizeof(Real110TonTable ), Real110TonTable , Oil110TonTable },
    {0x8120, sizeof(Real120WTonTable), Real120WTonTable, Oil120WTonTable},      //120W
    {0x0150, sizeof(Real150TonTable ), Real150TonTable , Oil150TonTable },
    {0x0200, sizeof(Real200TonTable ), Real200TonTable , Oil200TonTable },
    {0x8200, sizeof(RealQ200TonTable), RealQ200TonTable, OilQ200TonTable},   //Q200
    {0x0250, sizeof(Real250TonTable ), Real250TonTable , Oil250TonTable },
    {0x0300, sizeof(Real300TonTable ), Real300TonTable , Oil300TonTable },
    {0x0360, sizeof(Real360TonTable ), Real360TonTable , Oil360TonTable },
    {0x0450, sizeof(Real450TonTable ), Real450TonTable , Oil450TonTable },
    {0x0530, sizeof(Real530TonTable ), Real530TonTable , Oil530TonTable },
    {0x0650, sizeof(Real650TonTable ), Real650TonTable , Oil650TonTable },
    {0x0700, sizeof(Real700TonTable ), Real700TonTable , Oil700TonTable },
    {0x0780, sizeof(Real780TonTable ), Real780TonTable , Oil780TonTable },
    {0x0800, sizeof(Real800TonTable ), Real800TonTable , Oil800TonTable },
    {0x1000, sizeof(Real1000TonTable), Real1000TonTable, Oil1000TonTable},
    {0x1250, sizeof(Real1250TonTable), Real1250TonTable, Oil1250TonTable},
    {0x9250, sizeof(Real1250WTonTable), Real1250WTonTable, Oil1250WTonTable},   //1250W
    {0x1260, sizeof(Real1260TonTable), Real1260TonTable, Oil1260TonTable},
    {0x1600, sizeof(Real1600TonTable), Real1600TonTable, Oil1600TonTable},
	{(WORD)-1, 0, NULL, NULL}   // 必須存在, 表示結束
};

// 需要使用推力座de參數列表
char*        g_apcVatTransID[] = {
            "ADPOSI_CLOSE1END",                       // 01AA 關模一段終止位置
            "ADPOSI_CLOSE2END",                       // 01AB 關模二段終止位置
            "ADPOSI_CLOSE3END",                       // 01AC 關模三段終止位置
            "ADPOSI_CLOSEPROTECTEND",                 // 01AD 關模低壓終止位置
            "ADPOSI_CLOSEHIGHEND",                    // 008E 關模高壓終止位置
            "ADPOSI_HIGHPRESSURECLOSE",               // 0242 高壓鎖模位置
            "ADPOSI_HIGHPRESSUREOPEN",                // 0245 高壓開模位置
            "ADPOSI_OPENEND1",                        // 01CA 開模一段終止位置
            "ADPOSI_OPENEND2",                        // 01CB 開模二段終止位置
            "ADPOSI_OPENEND3",                        // 01CC 開模三段終止位置
            "ADPOSI_OPENEND4",                        // 01CD 開模四段終止位置
            "ADPOSI_OPENEND5",                        // 01CE 開模五段終止位置

            "ADPOSI_EJECTTRAVEL",                     // 0322 中途托模位置
            "ADPOSI_COREAINACT",                      // 020F 中子A進動作位置
            "ADPOSI_COREAOUTACT",                     // 0210 中子A退動作位置
            "ADPOSI_COREBINACT",                      // 0211 中子B進動作位置
            "ADPOSI_COREBOUTACT",                     // 0212 中子B退動作位置
            "ADPOSI_CORECINACT",                      // 0213 中子C進動作位置
            "ADPOSI_CORECOUTACT",                     // 0214 中子C退動作位置
            "ADPOSI_COREDINACT",                      // 0215 中子D進動作位置
            "ADPOSI_COREDOUTACT",                     // 0216 中子D退動作位置
            "ADPOSI_COREEINACT",                      // 0215 中子E進動作位置
            "ADPOSI_COREEOUTACT",                     // 0216 中子E退動作位置
            "ADPOSI_COREFINACT",                      // 0215 中子F進動作位置
            "ADPOSI_COREFOUTACT",                     // 0216 中子F退動作位置
            "ADPOSI_MOVINGPLATENBLASTSTART",          // 0330 公模吹氣動作位置
            "ADPOSI_STATEPLATENBLASTSTART",           // 0334 母模吹氣動作位置
            "ADPOSI_AIRBLT3START",                    // 0333 吹氣#3動作位置
            "ADPOSI_AIRBLT4START",                    // 033D 吹氣#4動作位置
            "ADPOSI_AIRBLT5START",                    // 033D 吹氣#4動作位置
            "ADPOSI_AIRBLT6START",                    // 033D 吹氣#4動作位置
            NULL                                      // 必須存在, 表示結束
            };

/*===========================================================================+
|           Global static variable                                           |
+===========================================================================*/
CSelvat*     g_pSelvat;
/*===========================================================================+
|           Function implementation                                          |
+===========================================================================*/
/*==========================================================================+
|           Class implementation - CSelvat                                  |
+==========================================================================*/
/*--------------------------------------------------------------------------+
|           Constructor and destructor                                      |
+--------------------------------------------------------------------------*/
CSelvat::CSelvat()
{
m_wCurTonValue      = 0;
m_wPreTonValue      = 0;
m_poutSelvatTable   = NULL;
m_apnRealTonTable   = NULL;
m_apnOilTonTable    = NULL;
m_poutRealOilPosi   = NULL;
}

CSelvat::~CSelvat()
{
if(m_poutSelvatTable != NULL)   free(m_poutSelvatTable);
if(m_apnRealTonTable != NULL)   free(m_apnRealTonTable);
if(m_apnOilTonTable  != NULL)   free(m_apnOilTonTable );
if(m_poutRealOilPosi != NULL)   free(m_poutRealOilPosi);
}

/*--------------------------------------------------------------------------+
|           Operations                                                      |
+--------------------------------------------------------------------------*/
/*---------------------------------------------------------------------------+
|  Function :  int        Create(SELVATINFO* pSelvatInfo)                    |
|  Task     :  Initialize Variable                                           |
+----------------------------------------------------------------------------+
|  Call     :                                                                |
|                                                                            |
|  Parameter:                           -                                    |
|                                                                            |
|  Return   :                           -                                    |
+---------------------------------------------------------------------------*/
WORD        CSelvat::Create(SELVATINFO* pSelvatInfo)
{
if(pSelvatInfo != NULL)
    {
    m_SelvatInfo = *pSelvatInfo;
    if(m_SelvatInfo.pcVatTransID == NULL)   m_wState = SELVAT_CREATE_FAILURE;
    else
        {
        // 如果數據來源於文檔, 則加載SELVATTABLE結構數組
        if((m_SelvatInfo.wDataSource & SELVAT_DATASOURCE_FILE) && (m_SelvatInfo.pcSelvatFileName != NULL))
            {
//            if(!WriteStaticDataToFile(m_SelvatInfo.pcSelvatFileName, m_SelvatInfo.pSelvatTable))
//                {
//                m_wState = SELVAT_CREATE_FAILURE;
//                return SELVAT_CREATE_FAILURE;
//                }

            if(LoadSelvatTableFile())   m_wState = SELVAT_CREATE_SUCCESS;
            else                        m_wState = SELVAT_CREATE_FAILURE;
            }
        // 如果數據來源於變量, 則判斷此變量指針是否為空
        else if(m_SelvatInfo.wDataSource & SELVAT_DATASOURCE_CONST)
            {
            if(m_SelvatInfo.pSelvatTable == NULL)   m_wState = SELVAT_CREATE_FAILURE;
            else                                    m_wState = SELVAT_CREATE_SUCCESS;
            }
        else    m_wState = SELVAT_CREATE_FAILURE;
        }
    }
else    m_wState = SELVAT_CREATE_FAILURE;

return  m_wState;
}

/*---------------------------------------------------------------------------+
|  Function :  BOOL           LoadSelvatTableFile()                          |
|  Task     :  Load selvat data from file                                    |
+----------------------------------------------------------------------------+
|  Call     :                                                                |
|                                                                            |
|  Parameter:                           -                                    |
|                                                                            |
|  Return   :  TRUE: Load Successfully; FALSE: Load Error                    |
+---------------------------------------------------------------------------*/
BOOL        CSelvat::LoadSelvatTableFile()
{
short           i, nTableSize, nSelvatGroup = 0;
long            nFileLength;
long            nPosition;
WORD            wTon;
CtmFile	        fileSelvat;
SELVATTABLE     temp = {(WORD)-1, 0, NULL, NULL};

//=======
// 讀取推力座數據文件
//=======
// Load SELVATTABLE from file
// 推力座數據文件格式
// 推力座組數(short nGroup; sizeof(short))
// Repeat begin
// 推力座一組參數(WORD wTon; short nTableSize)
// 推力座對應數據位置(int anRealTonTable; sizof(int)*nTableSize)
// 推力座對應數據位置(int anOilTonTable ; sizof(int)*nTableSize)
// Repeat end
if(fileSelvat.Open(m_SelvatInfo.pcSelvatFileName) != tmFILE_GOOD)   return FALSE;
nFileLength	= fileSelvat.Seek(0, SEEK_END);
nPosition   = 0;
fileSelvat.Seek(nPosition, SEEK_SET);
fileSelvat.Read(&nSelvatGroup, sizeof(short));
nPosition  += sizeof(short);
if(nSelvatGroup > 0)
    {
    m_poutSelvatTable = (SELVATTABLE *)malloc(sizeof(SELVATTABLE)*(nSelvatGroup+1));
    m_poutRealOilPosi = (int *)malloc(sizeof(int)*(nSelvatGroup+1));
    }
for(i=0; i<nSelvatGroup; i++)
    {
    if((long)(nPosition + sizeof(WORD)) >= nFileLength)
        {
        m_poutRealOilPosi[i] = 0;
        m_poutSelvatTable[i] = temp;
        break;
        }
    fileSelvat.Seek(nPosition, SEEK_SET);
    fileSelvat.Read(&wTon      , sizeof(WORD));
    fileSelvat.Read(&nTableSize, sizeof(WORD));
    nPosition += (sizeof(WORD)*2);
    m_poutSelvatTable[i].wTonValue      = wTon;
    m_poutSelvatTable[i].wTableSize     = nTableSize*sizeof(int);
    m_poutRealOilPosi[i]                = nPosition;
    m_poutSelvatTable[i].pnRealTonTable = &m_poutRealOilPosi[i];
    m_poutSelvatTable[i].pnOilTonTable  = NULL;
    nPosition += (m_poutSelvatTable[i].wTableSize*2);
    }
m_poutRealOilPosi[nSelvatGroup] = 0;
m_poutSelvatTable[nSelvatGroup] = temp;
fileSelvat.Close();

return TRUE;
}

/*---------------------------------------------------------------------------+
|  Function :  BOOL           LoadSelvatData(WORD wTon)                      |
|  Task     :  Load selvat data from file                                    |
+----------------------------------------------------------------------------+
|  Call     :                                                                |
|                                                                            |
|  Parameter:                           -                                    |
|                                                                            |
|  Return   :  TRUE: Load Successfully; FALSE: Load Error                    |
+---------------------------------------------------------------------------*/
BOOL        CSelvat::LoadSelvatData(WORD wTon)
{
int             i;
CtmFile	        fileSelvat;
if(m_poutSelvatTable != NULL)
    {
    i = 0;
    while(m_poutSelvatTable[i].wTonValue != (WORD)-1)
        {
        if(m_poutSelvatTable[i].wTonValue == wTon)
            {
            if(fileSelvat.Open(m_SelvatInfo.pcSelvatFileName) != tmFILE_GOOD)   return FALSE;
            // 在讀取前先把m_apnRealTonTable和m_apnOilTonTable內存釋放掉
		    if(m_apnRealTonTable != NULL)   free(m_apnRealTonTable);
		    if(m_apnOilTonTable  != NULL)   free(m_apnOilTonTable );
		    m_apnRealTonTable = (int *)malloc(m_poutSelvatTable[i].wTableSize);
		    m_apnOilTonTable  = (int *)malloc(m_poutSelvatTable[i].wTableSize);
		    // 從指定位置把推力座數據從文檔中讀出
            fileSelvat.Seek((long)(*(m_poutSelvatTable[i].pnRealTonTable)), SEEK_SET);
            fileSelvat.Read(m_apnRealTonTable, m_poutSelvatTable[i].wTableSize);
            fileSelvat.Read(m_apnOilTonTable , m_poutSelvatTable[i].wTableSize);
            fileSelvat.Close();
            return TRUE;
            }
        i++;
        }
    }
return FALSE;
}

/*---------------------------------------------------------------------------+
|  Function :  BOOL WriteStaticDataToFile(char* pfilename,                   |
|                                         SELVATTABLE* pselvattable)         |
|  Task     :  靜態數據寫入文檔                                              |
+----------------------------------------------------------------------------+
|  Call     :                                                                |
|                                                                            |
|  Parameter:                           -                                    |
|                                                                            |
|  Return   :  TRUE: Load Successfully; FALSE: Load Error                    |
+---------------------------------------------------------------------------*/
BOOL        CSelvat::WriteStaticDataToFile(char* pfilename, SELVATTABLE* pselvattable)
{
CtmFile	        fileSelvat;
int             nPosition = 0;
short           i = 0;
WORD            wTableSize;

if(pfilename == NULL)                           return FALSE;
if(fileSelvat.Open(pfilename) != tmFILE_GOOD)   return FALSE;
nPosition += sizeof(short);
fileSelvat.Truncate(nPosition);
fileSelvat.Write(&i, sizeof(short));
i = 0;
while(pselvattable[i].wTonValue != (WORD)-1)
    {
    nPosition += (sizeof(short) + sizeof(WORD) + pselvattable[i].wTableSize*2);
    wTableSize = pselvattable[i].wTableSize/sizeof(int);
    fileSelvat.Truncate(nPosition);
    fileSelvat.Write(&pselvattable[i].wTonValue     , sizeof(WORD));
    fileSelvat.Write(&wTableSize                    , sizeof(WORD));
    fileSelvat.Write( pselvattable[i].pnRealTonTable, pselvattable[i].wTableSize);
    fileSelvat.Write( pselvattable[i].pnOilTonTable , pselvattable[i].wTableSize);
    i ++;
    }
fileSelvat.Seek(0, SEEK_SET);
fileSelvat.Write(&i, sizeof(short));
fileSelvat.Close();
return TRUE;
}

/*---------------------------------------------------------------------------+
|  Function :  BOOL           GetOilTable()                                  |
|  Task     :  根據指定的噸數來加載相應的推理座資料                          |
+----------------------------------------------------------------------------+
|  Call     :  LoadOilTableFile()                                            |
|                                                                            |
|  Parameter:                           -                                    |
|                                                                            |
|  Return   :  TRUE: Load Successfully; FALSE: Load Error                    |
+---------------------------------------------------------------------------*/
BOOL        CSelvat::GetOilTable()
{
int				i;
SELVATTABLE*	pTableIndex;

if(m_wState == 0x0)     return FALSE;
// 從資料表中讀取當前推理座噸數值
if(m_SelvatInfo.pcOilVatSelectCode == NULL)    return FALSE;
m_wCurTonValue = GetDBValue(m_SelvatInfo.pcOilVatSelectCode).lValue;
if(m_SelvatInfo.wDataSource & SELVAT_DATASOURCE_CONST)       pTableIndex = m_SelvatInfo.pSelvatTable;
else if(m_SelvatInfo.wDataSource & SELVAT_DATASOURCE_FILE)   pTableIndex = m_poutSelvatTable;
else return FALSE;
if(m_wCurTonValue != m_wPreTonValue)
    {
    i = 0;
	while (pTableIndex[i].wTonValue != (WORD)-1)
		{
		// 噸數命名: wTonValue-(0x0000~0x7000); wTonValue(W)-(0x8000~0xF000)
		// 如: 120: 0x0120, 120W: 0x8120, 1600: 0x1600, 1600W: 0x9600
		// 若te殊值較多, 在定義時可以改變最後一位數字(不衝突的情況下)
		if (m_wCurTonValue == pTableIndex[i].wTonValue)
			{
			m_wPreTonValue  = m_wCurTonValue;
	        m_Realhigh      = pTableIndex[i].wTableSize/sizeof(int)-1;
	        m_Oilhigh       = pTableIndex[i].wTableSize/sizeof(int)-1;
	        if (m_SelvatInfo.wDataSource & SELVAT_DATASOURCE_CONST)
    	        {
    	        m_pTonRealTable = pTableIndex[i].pnRealTonTable;
                m_pTonOilTable  = pTableIndex[i].pnOilTonTable;
    		    }
    		else
    		    {
    		    if(!LoadSelvatData(m_wCurTonValue))    return FALSE;//Load selvat from file
    			m_pTonRealTable = m_apnRealTonTable;
                m_pTonOilTable  = m_apnOilTonTable;
    		    }
	        return	TRUE;
			}
		i++;
		}
	}
else
    {
    if(m_wCurTonValue == 0) return FALSE;
    else                    return TRUE;
    }

return FALSE;
}

/*---------------------------------------------------------------------------+
|  Function :  int         GetOilVat(int x)                                  |
|  Task     :  Exchange real position to oil position                        |
+----------------------------------------------------------------------------+
|  Call     :                                                                |
|                                                                            |
|  Parameter:  x : real position                                             |
|                                                                            |
|  Return   :  y : oil position                                              |
+---------------------------------------------------------------------------*/
int         CSelvat::GetOilVat(int x)
{
int     pos;
int     low, high, mid;
int     y;
long    k,deltaX,deltaY;

if (x == -1)             return -1;
else if (x <= 0)         return 0;
else if (!GetOilTable()) return x;

low  = 0;
high = m_Realhigh;
while (high - low > 1)                     /* stop?                 */
    {
    mid = (low + high) / 2;
    if (x >= *(m_pTonRealTable+mid))
        low  = mid;                        /* try right             */
    else
        high =mid;                         /* try left              */
    }
pos    = low;
deltaX = *(m_pTonRealTable+pos+1) - *(m_pTonRealTable+pos);
deltaY = *(m_pTonOilTable+pos+1) - *(m_pTonOilTable+pos);
k      = (long)(deltaY * (x-*(m_pTonRealTable+pos)) + deltaX/2) / deltaX;
y      = (int)k+*(m_pTonOilTable+pos);

return y;
}

/*---------------------------------------------------------------------------+
|  Function :  int         OilToPosi(int y)                                  |
|  Task     :  Exchange oil position to real position                        |
+----------------------------------------------------------------------------+
|  Call     :                                                                |
|                                                                            |
|  Parameter:  y : oil position                                              |
|                                                                            |
|  Return   :  x : real position                                             |
+---------------------------------------------------------------------------*/
int         CSelvat::OilToPosi(int y)
{
int     pos;
int     low, high, mid;
int     x;
long    k,deltaX,deltaY;

if (!GetOilTable()||(y == -1)) return y;
if (y >= *(m_pTonOilTable+m_Oilhigh)) return *(m_pTonRealTable+m_Oilhigh);

low = 0;
high = m_Oilhigh;
while (high - low > 1)                     /* stop?                 */
    {
    mid = (low + high) / 2;
    if (y >= *(m_pTonOilTable+mid))
        low  = mid;                        /* try right             */
    else
        high =mid;                         /* try left              */
    }
pos    = low;
deltaX = *(m_pTonRealTable+pos+1) - *(m_pTonRealTable+pos);
deltaY = *(m_pTonOilTable+pos+1) - *(m_pTonOilTable+pos);
k      = (long)(deltaX * (y-*(m_pTonOilTable+pos)) + deltaY/2) / deltaY;
x      = (int)k+*(m_pTonRealTable+pos);

return x;
}

/*---------------------------------------------------------------------------+
|  Function :  BOOL       	CheckOilVatID(char* pcIDOilVat)                  |
|  Task     :  檢查指定參數是否屬於推理座參數                                |
+----------------------------------------------------------------------------+
|  Call     :                                                                |
|                                                                            |
|  Parameter:                           -                                    |
|                                                                            |
|  Return   :                           -                                    |
+---------------------------------------------------------------------------*/
BOOL       	CSelvat::CheckOilVatID(char* pcIDOilVat)
{
short       i = 0;

if(m_wState == 0x0)     return FALSE;
while(m_SelvatInfo.pcVatTransID[i] != NULL)
    {
    if (strcmp(m_SelvatInfo.pcVatTransID[i], pcIDOilVat) == 0)     return TRUE;
    i++;
    }

return FALSE;
}

/*---------------------------------------------------------------------------+
|  Function :  void    TransferOilVat(BYTE* panBuffer)                       |
|  Task     :  轉換所有的推理座參數為油缸位置                                |
+----------------------------------------------------------------------------+
|  Call     :                                                                |
|                                                                            |
|  Parameter:                           -                                    |
|                                                                            |
|  Return   :                           -                                    |
+---------------------------------------------------------------------------*/
void        CSelvat::TransferOilVat(BYTE* panBuffer)
{
short       i = 0;
DWORD		dwOilVat;

if (m_wState == 0x0)    return;
while(m_SelvatInfo.pcVatTransID[i] != NULL)
    {
    if(g_ptaskrs232 != NULL)
        {
        g_pBlock->GetBlockValue(panBuffer, BLOCK_MOLDSET_ID, m_SelvatInfo.pcVatTransID[i], &dwOilVat);
        g_pBlock->SetBlockValue(panBuffer, BLOCK_MOLDSET_ID, m_SelvatInfo.pcVatTransID[i], GetOilVat((int)dwOilVat)); // DWORD --> int ???
        }
    i++;
    }
}

/*---------------------------------------------------------------------------+
|  Function :  void    SendOilVat()                                          |
|  Task     :  傳送所有的推理座參數到主機                                    |
+----------------------------------------------------------------------------+
|  Call     :  SendControlIndex_TaskComm()                                   |
|                                                                            |
|  Parameter:                           -                                    |
|                                                                            |
|  Return   :                           -                                    |
+---------------------------------------------------------------------------*/
void        CSelvat::SendOilVat()
{
short       i = 0;

if (m_wState == 0x0)     return;
while(m_SelvatInfo.pcVatTransID[i] != NULL)
    {
    if(g_ptaskrs232 != NULL)    g_ptaskrs232->SendControlIndex(m_SelvatInfo.pcVatTransID[i]);
    i++;
    }
}

/*---------------------------------------------------------------------------+
|  Function :  void           SetVatDefPosi()                                |
|  Task     :  轉換所有的推理座參數為模板位置                                |
+----------------------------------------------------------------------------+
|  Call     :                                                                |
|                                                                            |
|  Parameter:                           -                                    |
|                                                                            |
|  Return   :                           -                                    |
+---------------------------------------------------------------------------*/
void        CSelvat::SetVatDefPosi()
{
short       i = 0;
WORD        wValue;

if(m_wState == 0x0)     return;
while(m_SelvatInfo.pcVatTransID[i] != NULL)
    {
    wValue = GetDBValue(m_SelvatInfo.pcVatTransID[i]).lValue;
    SetDBValue(m_SelvatInfo.pcVatTransID[i],OilToPosi(wValue));
    i++;
    }
}

// 目前推力座使用說明:
// 1.	在通訊程式中, 需要把指定的參數資料轉換成推力座傳至主機: SetVatDefPosi()-->SendOilVat()或GetOilVat(int x)
// 2.	在通訊程式中, 需要把指定的參數資料轉換成模板位置給面板保存: OilToPosi(int y)
// 3.	在畫面上顯示開關模, 中子等位置時需把電子尺位置(即油缸位置)轉換成模板位置顯示: OilToPosi(int y)
// 4.	如果要顯示推力座位置, 則需把database中的指定參數資料(即模板位置)轉換成油缸位置: GetOilVat(int x)
